<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Crypto.Noise.Protocol</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Crypto-Noise-Protocol.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">noise-0.0.0.0: Usable security for the internet, Deux</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Portability</th><td>portable</td></tr><tr><th>Stability</th><td>experimental</td></tr><tr><th>Maintainer</th><td>aseipp@pobox.com</td></tr><tr><th>Safe Haskell</th><td>Safe-Inferred</td></tr></table><p class="caption">Crypto.Noise.Protocol</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Introduction
</a></li><li><a href="#g:2">Connection overview
</a><ul><li><a href="#g:3">Minute-keys
</a></li></ul></li><li><a href="#g:4">Wire format
</a></li><li><a href="#g:5">Congestion avoidance: Chicago
</a></li><li><a href="#g:6">Differences from the reference code
</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>This module describes the Noise implementation given in this
 library. The official protocol format can be found
 <a href="https://github.com/trevp/noise/wiki/">here</a>.
</p></div></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"></ul></div><div id="interface"><h1 id="g:1">Introduction
</h1><div class="doc"><p>A CurveCP connection begins life with a <code>HELLO</code> packet from a client,
a <code>COOKIE</code> packet from the server, and finally an <code>INITIATE</code> packet
from the client. An <code>INITIATE</code> packet may contain application
data. Afterwords, the server is free to send any number of Message
packets after a valid <code>INITIATE</code>. The client may send any number of
message packets after the first Message from the server.
</p><p>If a client doesn't see a <code>COOKIE</code> packet, it will send another
<code>HELLO</code>. Similarly, a client may send multiple <code>INITIATE</code> packets if
it does not see a Message.
</p><dl><dt><code>Notation</code></dt><dd>
</dd></dl><ul><li> <code>S</code>  : Server long-term public key
</li><li> <code>s</code>  : Server long-term secret key
</li><li> <code>S'</code> : Server short-term public key
</li><li> <code>s'</code> : Server short-term secret key
</li><li> <code>C</code> : Client long-term public key
</li><li> <code>c</code> : Client long-term secret key
</li><li> <code>C'</code> : Client short-term public key
</li><li> <code>c'</code> : Client short-term secret key
</li><li> <code>t</code> : Minute-key
</li><li> <code>Z</code> : All zeros.
</li><li> <code>N</code> : Server domain name
</li><li> <code>...</code> or <code>M</code> : Message
</li><li> <code>Box[X](C-&gt;S)</code> : Encrypt-and-authenticate <code>X</code> from the client's
public key <code>C</code> to the server's public key <code>S</code>.
</li><li> <code>V</code> : Vouch packet - <code>Box[C'](C-&gt;S)</code>
</li><li> <code>K</code> : Cookie packet - <code>Box[C',s'](t)</code>
</li></ul></div><h1 id="g:2">Connection overview
</h1><div class="doc"><p>The following diagram describes the lifetime of a CurveCP connection
from beginning to end. Note that <code>INITIATE</code> packets may contain
application data: there are only two packets necessary for the client
to begin sending data, and three packets before the server may send
data.
</p><pre>
             Client                                                 Server
+-------------------------------+                      +-------------------------------+
|    (C', 0, Box[Z](C'-&gt;S))     | ------ HELLO ------&gt; |           Received            | Client sends HELLO
+-------------------------------+                      +-------------------------------+
                                                                      |
                                                                      v
+-------------------------------+                      +-------------------------------+
|           Received            | &lt;----- COOKIE ------ |       (Box[S',K](S-&gt;C'))      | Server sends COOKIE
+-------------------------------+                      +-------------------------------+
               |
               v
+-------------------------------+                      +-------------------------------+
| (C',K,Box[C,V,N,...](C'-&gt;S')) | ----- INITIATE ----&gt; |           Received            | Client sends INITIATE
+-------------------------------+                      +-------------------------------+
                                                                      |
                                                                      v
+-------------------------------+                      +-------------------------------+
|           Received            | &lt;------ SMSG ------- |       (Box[...](S'-&gt;C'))      | Server sends Message
+-------------------------------+                      +-------------------------------+
               |
               v
+-------------------------------+                      +-------------------------------+
|    (C',Box[...](C'-&gt;S'))      | ------- CMSG ------&gt; |            Received           | Client sends Message
+-------------------------------+                      +-------------------------------+
                                                                      |
                                                                      v
+-------------------------------+                      +-------------------------------+
|           Received            | &lt;------ SMSG ------- |       (Box[...](S'-&gt;C'))      | Server sends Message
+-------------------------------+                      +-------------------------------+
               |
               v
+-------------------------------+                      +-------------------------------+
|    (C',Box[...](C'-&gt;S'))      | ------- CMSG ------&gt; |            Received           | Client sends Message
+-------------------------------+                      +-------------------------------+
                                                                      |
                                                                      v
                                                                     ...
</pre></div><h2 id="g:3">Minute-keys
</h2><div class="doc"><p>The <em>minute key</em> <code>t</code> is a secret key for use only by the server, under
which a cookie <code>K</code> is encrypted. As <code>K</code> is encrypted to the client
inside a <code>COOKIE</code> packet, it provides a means of validating the
authentic client has responded.
</p><p>Once every minute, the server rotates the minute key <code>t</code>, while
retaining the prior key. Thus, at any given time, the server may
understand a cookie <code>K</code> from the past two minutes.
</p><p>When a server receives an
<code>INITIATE</code> packet, it attempts to decrypt and validate <code>K</code> with
respect to the current and prior minute keys.
</p></div><h1 id="g:4">Wire format
</h1><div class="doc"><p>The following describes the wire format of all packets and messages.
</p><p>In the following layouts, the notation <code>n : m : F</code> means the field <code>F</code>
is located at offset <code>n</code> and is <code>m</code> bytes long. The notation <code>m:F</code>
(used inline) means <code>F</code> is <code>m</code> bytes long.
</p><p>Note that the overhead of a <code>Box</code> is 16 bytes: if <code>length(T) = x</code> then
<code>length(Box[T](C-&gt;S)) = x+16</code>
</p><dl><dt><em>HELLO</em></dt><dd> - 224 byte packet; Client -&gt; Server
</dd></dl><pre>
0   : 8  : magic, &quot;QvnQ5XlH&quot;
8   : 16 : server extension
24  : 16 : client extension
40  : 32 : C'
72  : 64 : Z
136 : 8  : compressed nonce
144 : 80 : Box[64:Z](C'-&gt;S)
</pre><dl><dt><em>COOKIE</em></dt><dd> - 200 byte packet; Server -&gt; Client
</dd></dl><pre>
0  : 8   : magic, &quot;RL3aNMXK&quot;
8  : 16  : client extension
24 : 16  : server extension
40 : 16  : compressed nonce
56 : 144 : Box[S',K](S-&gt;C') where:
            K = 0  : 16 : compressed cookie nonce
                16 : 80 : Box[C',s'](t)
</pre><dl><dt><em>INITIATE</em></dt><dd> - (544+M)-byte packet; Client -&gt; Server
</dd></dl><pre>
0   : 8     : magic, &quot;QvnQ5XlI&quot;
8   : 16    : server extension
24  : 16    : client extension
40  : 32    : C'
72  : 96    : cookie K, where:
               K = 0   : 16    : compressed cookie nonce
                   16  : 80    : Box[C',s'](t)
168 : 8     : compressed nonce
176 : 368+M : Box[X](C'-&gt;S') containing:
176 :          X = 0   : 32  : C client long-term public key
208 :              32  : 16  : compressed nonce
224 :              48  : 48  : Box[C'](C-&gt;S)
272 :              96  : 256 : N
528 :              352 : M   : M
</pre><dl><dt><em>SMSG</em></dt><dd> - (64+M)-byte packet
</dd></dl><pre>
0  : 8    : magic, &quot;RL3aNMXM&quot;
8  : 16   : client extension
24 : 16   : server extension
40 : 8    : compressed nonce
48 : 16+M : Box[M](S'-&gt;C')
</pre><dl><dt><em>CMSG</em></dt><dd> - (96+M)-byte packet
</dd></dl><pre>
0   : 8    : magic, &quot;QvnQ5XlM&quot;
8   : 16   : server extension
24  : 16   : client extension
40  : 32   : C'
72  : 8    : compressed nonce
80  : 16+M : Box[M](C'-&gt;S')
</pre><dl><dt><em>Message format</em></dt><dd>
</dd></dl></div><h1 id="g:5">Congestion avoidance: Chicago
</h1><div class="doc"><p><em>Chicago</em> is the congestion avoidance scheduling algorithm used by
CurveCP.
</p></div><h1 id="g:6">Differences from the reference code
</h1><div class="doc"><p>This module is not wire-format compatible with the original CurveCP
implementation, as written by Bernstein.
</p><p>Notably, it takes the advice written
<a href="http://codesinchaos.wordpress.com/2012/09/09/curvecp-1/">in this analysis</a> and
applies it. That is, the main differences are:
</p><dl><dt><code>Random Nonces</code></dt><dd> The server always uses random nonces due to
negligable collision risk and the fragility of incrementing nonces.
</dd><dt><code>Stronger client authentication</code></dt><dd> Lorem ipsum...
</dd><dt><code>Stopping INITIATE replays</code></dt><dd> The server puts <code>C'</code> on a blacklist
when initiating connections, so that attackers cannot replay a full
connection while the minute-key associated with the packet is
valid. Connections with an in-use short-term key are also prevented.
</dd></dl></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.13.2.1</p></div></body></html>